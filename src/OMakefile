# if $(not $(defined-env VERBOSE))
#   OMakeFlags(-S --progress)
#   export

SRCTOP = $(shell pwd)

if $(or $(equal $(OSTYPE), Win32), $(equal $(OSTYPE), WindowsNT))
  CXXFLAGS = -EHsc -W3 -wd4800 -wd4819 -wd4996 -U__STRICT_ANSI__ /J -I$(SRCTOP) -I$(SRCTOP)/../vendor $(if $(defined-env DEBUG), -Od, -O2) $(shell sdl-config --cflags) $(PLATFORMFLAGS) -D_THREAD_SAFE -DSDL_main=main
  export
else
  CXXFLAGS = --ansi -Wall -U__STRICT_ANSI__ -funsigned-char -I$(SRCTOP) -I$(SRCTOP)/../vendor $(if $(defined-env DEBUG), -g, -O2) $(shell sdl-config --cflags) $(PLATFORMFLAGS) -D_THREAD_SAFE
  export

# for testing
#CXXFLAGS += -DWIN32

.PHONY: clean
.SUBDIRS: libReallive Modules MachineBase Systems
########

LIBRLVMFILES[] = 
  MachineBase/libMachineBase
  MachineBase/GeneralOperations
  Modules/libModules
  Systems/Base/System
  Systems/Base/GraphicsSystem
  Systems/Base/GraphicsObject
  Systems/Base/GraphicsObjectData
  Systems/Base/GraphicsObjectOfFile
  Systems/Base/GraphicsTextObject
  Systems/Base/GraphicsStackFrame
  Systems/Base/ObjectSettings
  Systems/Base/FrameCounter
  Systems/Base/EventSystem
  Systems/Base/EventHandler
  Systems/Base/RLTimer
  Systems/Base/SystemError
  Systems/Base/TextWindow
  Systems/Base/TextWindowButton
  Systems/Base/TextPage
  Systems/Base/TextSystem
  Systems/Base/TextKeyCursor
  Systems/Base/GanGraphicsObjectData
  Systems/Base/AnmGraphicsObjectData
  Systems/Base/SelectionElement
  Systems/SDL/libSDLSystem
  libReallive/libReallive
  Utilities
  dateUtil
  ../vendor/libVendorLibs

# Build our precompiled headers
Precompiled.hpp.gch: Precompiled.hpp
  if $(or $(equal $(OSTYPE), Win32), $(equal $(OSTYPE), WindowsNT))
    echo "tag" > $@
  else
    $(CXX) $(CXXFLAGS) -I. -x c++-header -c $< -o $@
CGeneratedFiles(Precompiled.hpp.gch)

StaticCLibrary(librlvm, $(LIBRLVMFILES))

########

if $(or $(equal $(OSTYPE), Win32), $(equal $(OSTYPE), WindowsNT))
  LDOUT = /Fo
  LDFLAGS += /link $(if $(defined-env DEBUG), /DEBUG, /RELEASE) -LIBPATH:$(SRCTOP) -LIBPATH:$(SRCTOP)\..\vendor librlvm$(EXT_LIB) $(shell sdl-config --libs) $(PLATFORMLIBS) SDL.lib SDL_image.lib SDL_ttf.lib
  export
else
  LDFLAGS += librlvm$(EXT_LIB) $(shell sdl-config --libs) $(shell freetype-config --libs) -lSDL_image $(PLATFORMLIBS) -lboost_program_options -lboost_serialization -lboost_filesystem -lboost_date_time
  export

.DEFAULT: librlvm$(EXT_LIB) $(CXXProgram rlvm, rlvm)
rlvm$(EXE): librlvm$(EXT_LIB) 

clean:
  $(RM) *.o *.gch *$(EXT_LIB) *.omc rlvm$(EXE) rlvm$(EXE).stackdump
