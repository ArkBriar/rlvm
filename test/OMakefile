if $(not $(defined-env VERBOSE))
  OMakeFlags(-S --progress)
  export

if $(or $(equal $(OSTYPE), Win32), $(equal $(OSTYPE), WindowsNT))
  CXXFLAGS += -EHsc -W3 -wd4800 -wd4819 -wd4996 -U__STRICT_ANSI__ /J $(if $(defined-env DEBUG), -Od, -O2) $(shell sdl-config --cflags) $(PLATFORMFLAGS) -I../src -D_THREAD_SAFE
  export
else
  CXXFLAGS += --ansi -U__STRICT_ANSI__ -funsigned-char $(if $(defined-env DEBUG), -g, -O2) $(shell sdl-config --cflags) $(PLATFORMFLAGS) -I../src -D_THREAD_SAFE -I/usr/include/lua50 $(shell sdl-config --cflags)
  export

.PHONY: clean

.SUBDIRS: NullSystem Module_Str_SEEN Module_Mem_SEEN Module_Jmp_SEEN Module_Sys_SEEN ExpressionTest_SEEN ScriptMachine

INCLUDES += ../src
if $(or $(equal $(OSTYPE), Win32), $(equal $(OSTYPE), WindowsNT))
  LDOUT = /Fo
  LDFLAGS += /link $(if $(defined-env DEBUG), /DEBUG, /RELEASE) ../src/librlvm$(EXT_LIB) $(shell sdl-config --libs) $(PLATFORMLIBS) SDL.lib SDL_image.lib SDL_ttf.lib
  export
else
  LDFLAGS += ../src/librlvm$(EXT_LIB) $(shell sdl-config --libs)  $(shell freetype-config --libs) -lSDL_image -lSDL_mixer $(PLATFORMLIBS) -lboost_program_options -lboost_filesystem -lboost_serialization -lboost_date_time -lboost_thread -lboost_iostreams  -llua50 -lluabind
  export


TEST_FILES[] =
  testUtils
  RLMachine_TUT
  Module_Jmp_TUT
  Module_Str_TUT
  Module_Mem_TUT
  Module_Sys_TUT
  ExpressionTest_TUT
  TextSystem_TUT
  Gameexe_TUT
  LazyArray_TUT
  GraphicsObject_TUT
  Effect_TUT
  NullSystem/NullSystem
  NullSystem/NullEventSystem
  NullSystem/NullTextSystem
  NullSystem/NullTextWindow
  NullSystem/NullGraphicsSystem
  NullSystem/NullSoundSystem
  NullSystem/NullSurface
  NullSystem/MockLog
  ScriptMachine/ScriptWorld
  ScriptMachine/ScriptMachine
  ScriptMachine/luabind_Machine
  ScriptMachine/luabind_System
  ScriptMachine/luabind_EventSystem
  ScriptMachine/luabind_GraphicsSystem
  ScriptMachine/luabind_GraphicsObject
  ScriptMachine/luabind_utility


.DEFAULT: $(CXXProgram rlvmTest, $(TEST_FILES) rlvmTest) $(CXXProgram luaRlvm, $(TEST_FILES) luaRlvm)
# TODO: These dependencies are FUCKED.
rlvmTest$(EXE): ../src/librlvm$(EXT_LIB) Module_Str_SEEN Module_Mem_SEEN Module_Jmp_SEEN
luaRlvm$(EXE): ../src/librlvm$(EXT_LIB)
clean:
  $(RM) *.o *.gch *$(EXT_LIB) *.omc rlvmTest$(EXE) rlvmTest$(EXE).stackdump
